Paint.Views.PaintView=Backbone.View.extend({el:$("#container"),socket:Paint.socketPaint,painting:!1,points:[],initialize:function(){_.bindAll(this,"render","loadBoard","paintIn","paintAll","mouseInUp","borrarLienzo","clearCanvasIn","startDraw","moveDraw","stopDraw","changeColor","changeYellow","changeBlue","changeOrange","changePink","changeGreen","changeRed","changeBlack","changeWhite","showSlider","initCanvas","showUsers","showChat","smoothLines","changeOrientationIn","allOrientationIn");this.socket.on("paint_in",
this.paintIn);this.socket.on("paint_all",this.paintAll);this.socket.on("mouse_in_up",this.mouseInUp);this.socket.on("clear_canvas_in",this.clearCanvasIn);Paint.socketChat.on("change_orientation:in",this.changeOrientationIn);Paint.socketChat.on("all_orientation:in",this.allOrientationIn);this.render();this.alpha=this.blue=this.green=this.red=0;this.pincelWidth=1;this.canvas=this.$el.find("#main-canvas");this.canvas[0].addEventListener("touchstart",this.startDraw,!1);this.canvas[0].addEventListener("touchmove",
this.moveDraw,!1);this.canvas[0].addEventListener("touchend",this.stopDraw,!1);this.pincel=this.canvas[0].getContext("2d");this.sizeShape=this.$el.find("#size-shape");this.sizeContainer=this.$el.find("#size-container");this.sliderContainer=this.$el.find("#slider-container");this.canvasContainer=this.$el.find("#canvas-container");this.usersContainer=this.$el.find("#users");this.chatContainer=this.$el.find("#chat");this.topicContainer=this.$el.find("#topic");this.userInfoContainer=this.$el.find("#user-info");
Paint.appWidth=0<window.innerWidth?window.innerWidth:screen.width;Paint.appHeight=0<window.innerHeight?window.innerHeight:screen.height;800>=window.appWidth?this.orientation="portrait":(this.orientation="landscape",this.sliderContainer.addClass("slider-invisible"));Paint.socketChat.emit("change_orientation:out",this.orientation);this.initCanvas();var a=this;window.addEventListener("orientationchange",function(){if(90==window.orientation||-90==window.orientation)a.orientation="portrait",a.sliderContainer.removeClass("slider-invisible");
else if(0==window.orientation||180==window.orientation)a.orientation="landscape",a.sliderContainer.addClass("slider-invisible");Paint.socketChat.emit("change_orientation:out",a.orientation);a.initCanvas();a.loadBoard()})},render:function(){},changeOrientationIn:function(a){"landscape"==a.o?(this.$el.find("#"+a.id+" .image-user").removeClass("portrait"),this.$el.find("#"+a.id+" .image-user").addClass("landscape")):(this.$el.find("#"+a.id+" .image-user").removeClass("landscape"),this.$el.find("#"+a.id+
" .image-user").addClass("portrait"))},allOrientationIn:function(a){for(var b=0;b<a.length;b++)"landscape"==a[b].o?(this.$el.find("#"+a[b].id+" .image-user").removeClass("portrait"),this.$el.find("#"+a[b].id+" .image-user").addClass("landscape")):(this.$el.find("#"+a[b].id+" .image-user").removeClass("landscape"),this.$el.find("#"+a[b].id+" .image-user").addClass("portrait"))},initCanvas:function(){window.appWidth=0<window.innerWidth?window.innerWidth:screen.width;window.appHeight=0<window.innerHeight?
window.innerHeight:screen.height;"landscape"==this.orientation?(this.canvasWidth=window.appWidth-59,this.canvasHeight=window.appHeight):"portrait"==this.orientation&&(this.canvasWidth=window.appWidth,this.canvasHeight=window.appHeight-59);this.canvas[0].setAttribute("width",this.canvasWidth);this.canvas[0].setAttribute("height",this.canvasHeight);this.pincel.lineCap="round";this.pincel.lineJoin="round";this.pincel.lineWidth=this.pincelWidth;this.pincel.strokeStyle="rgb("+this.red+","+this.green+","+
this.blue+")"},events:{"click #clear-canvas":"borrarLienzo","change #slider":"changeSlider","click #yellow":"changeYellow","click #blue":"changeBlue","click #orange":"changeOrange","click #pink":"changePink","click #green":"changeGreen","click #red":"changeRed","click #black":"changeBlack","click #white":"changeWhite","click #slider-button":"showSlider","click #users #head":"showUsers","click #chat #head":"showChat","click #save-canvas":"guardarLienzo","click #logout":"salir"},changeYellow:function(){this.changeColor(251,
241,32)},changeBlue:function(){this.changeColor(59,119,251)},changeOrange:function(){this.changeColor(225,133,30)},changePink:function(){this.changeColor(211,56,87)},changeGreen:function(){this.changeColor(105,216,23)},changeRed:function(){this.changeColor(212,53,14)},changeBlack:function(){this.changeColor(0,0,0)},changeWhite:function(){this.changeColor(255,255,255)},salir:function(){DBclient.signOut()},guardarLienzo:function(){console.log(Paint.actualBoard);if(0==Paint.actualBoard){!window.BlobBuilder&&
window.WebKitBlobBuilder&&(window.BlobBuilder=window.WebKitBlobBuilder);for(var a=this.canvas[0].toDataURL("image/png"),b=atob(a.split(",")[1]),a=a.split(",")[0].split(":")[1].split(";")[0],c=new ArrayBuffer(b.length),e=new Uint8Array(c),d=0;d<b.length;d++)e[d]=b.charCodeAt(d);b=new BlobBuilder;b.append(c);b=b.getBlob(a);a=this.topicContainer.find("p").text();c=this.topicContainer.find("span").text();this.userInfoContainer.find("p").text();DBclient.writeFile(a+"_("+c+").png",b,function(a){a?console.log(a):
alert("La imagen fue guardada con exito")})}},showUsers:function(){this.usersContainer.toggleClass("users-default");this.usersContainer.toggleClass("users-visible")},showChat:function(){this.chatContainer.toggleClass("chat-visible")},showSlider:function(){this.sliderContainer.toggleClass("slider-invisible")},changeSlider:function(a){a=$(a.currentTarget).val();this.pincelWidth=this.pincel.lineWidth=a;this.sizeShape.width();this.sizeShape.css("width",a);this.sizeShape.css("height",a);a=(this.sizeContainer.width()-
a)/2;this.sizeShape.css("left",a);this.sizeShape.css("top",a)},borrarLienzo:function(){this.socket.emit("clear_canvas")},changeColor:function(a,b,c){this.red=a;this.green=b;this.blue=c;this.pincel.strokeStyle="rgb("+this.red+","+this.green+","+this.blue+")";this.sizeShape.css("background","rgb("+this.red+","+this.green+","+this.blue+")")},clearCanvasIn:function(){this.clearCanvas(this.pincel);this.points=[]},loadBoard:function(){this.clearCanvas(this.pincel);this.points=[];for(var a=this.$el.find(".actual-user"),
b=0;b<a.length;b++)this.$el.find(a[b]).addClass("inactive"),this.$el.find(a[b]).removeClass("active");0!=Paint.actualBoard&&(this.$el.find("#"+Paint.actualBoard+" .actual-user").removeClass("inactive"),this.$el.find("#"+Paint.actualBoard+" .actual-user").addClass("active"));this.socket.emit("change",{id:Paint.actualBoard,orientation:this.orientation})},startDraw:function(a){this.painting=!0;finger=a.touches[0];a.preventDefault();var a=finger.pageX-this.canvasContainer[0].offsetLeft,b=finger.pageY-
this.canvasContainer[0].offsetTop;this.userInfoContainer.toggleClass("invisible");this.topicContainer.toggleClass("invisible");this.pincel.beginPath();this.pincel.moveTo(a,b);this.socket.emit("paint_out",[a,b,this.red,this.green,this.blue,this.pincel.lineWidth,0]);this.points.push([a,b,this.red,this.green,this.blue,this.pincel.lineWidth,0])},moveDraw:function(a){if(this.painting){finger=a.touches[0];a.preventDefault();var a=finger.pageX-this.canvasContainer[0].offsetLeft,b=finger.pageY-this.canvasContainer[0].offsetTop;
this.pincel.lineTo(a,b);this.pincel.stroke();this.pincel.closePath();this.pincel.beginPath();this.pincel.moveTo(a,b);this.socket.emit("paint_out",[a,b,this.red,this.green,this.blue,this.pincel.lineWidth,1]);this.points.push([a,b,this.red,this.green,this.blue,this.pincel.lineWidth,1])}},stopDraw:function(){this.painting=!1;this.userInfoContainer.toggleClass("invisible");this.topicContainer.toggleClass("invisible");this.socket.emit("mouse_up");this.smoothLines()},smoothLines:function(){this.clearCanvas(this.pincel);
for(var a=[],b=0;b<this.points.length;b++){var c=this.points[b];0==c[6]&&0!=b&&(this.drawPoints(a,this.pincel),a=[]);a.push(c)}this.drawPoints(a,this.pincel)},drawPoints:function(a,b){if(!(6>a.length)){b.beginPath();b.moveTo(a[0][0],a[0][1]);for(var c=1;c<a.length-2;c++)b.quadraticCurveTo(a[c][0],a[c][1],(a[c][0]+a[c+1][0])/2,(a[c][1]+a[c+1][1])/2);b.strokeStyle="rgb("+a[c][2]+","+a[c][3]+","+a[c][4]+")";b.lineWidth=a[c][5];b.quadraticCurveTo(a[c][0],a[c][1],a[c+1][0],a[c+1][1]);b.stroke();return!0}},
paintIn:function(a){switch(a[6]){case 0:this.pincel.strokeStyle="rgb("+a[2]+","+a[3]+","+a[4]+")";this.pincel.lineWidth=a[5];this.pincel.beginPath();this.pincel.moveTo(a[0],a[1]);break;case 1:this.pincel.strokeStyle="rgb("+a[2]+","+a[3]+","+a[4]+")",this.pincel.lineTo(a[0],a[1]),this.pincel.stroke(),this.pincel.moveTo(a[0],a[1]),this.pincel.closePath()}this.points.push(a);this.pincel.restore()},paintAll:function(a){this.pincel.save();for(j=0;j<a.length;j++){var b=JSON.parse(a[j]);this.points.push(b)}this.smoothLines();
this.pincel.restore()},mouseInUp:function(){this.smoothLines()},clearCanvas:function(a){a.clearRect(0,0,this.canvasWidth,this.canvasHeight);a.fillStyle="#fff";a.fillRect(0,0,this.canvasWidth,this.canvasHeight)}});